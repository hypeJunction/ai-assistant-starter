---
applyTo: "**/*"
priority: critical
role: [developer, tester, reviewer, architect]
---

# Global AI Assistant Instructions

> **Priority:** Critical - These rules apply to ALL files and ALL roles.
> **Context Files:** [INDEX.md](./INDEX.md) | [Project Memory](../.ai-project/.memory.md) | [Quick Reference](../.ai-project/.context.md)

## Layered Architecture

This framework uses a two-layer system for flexibility and reusability:

### Directory Structure

```
project/
â”œâ”€â”€ .ai-assistant/          # Base framework (submodule/symlink)
â”‚   â”œâ”€â”€ .instructions.md    # Global execution protocol (this file)
â”‚   â”œâ”€â”€ INDEX.md            # Cross-reference index
â”‚   â”œâ”€â”€ chatmodes/          # Role definitions
â”‚   â”œâ”€â”€ domains/            # Technology guidelines
â”‚   â”œâ”€â”€ workflows/          # Workflow definitions
â”‚   â”œâ”€â”€ tasks/              # Atomic task definitions
â”‚   â””â”€â”€ .ai-project/        # Template for project layer
â”‚
â”œâ”€â”€ .ai-project/            # Project-specific (created by /init)
â”‚   â”œâ”€â”€ .memory.md          # Project architecture & stack
â”‚   â”œâ”€â”€ .context.md         # Project patterns & imports
â”‚   â”œâ”€â”€ project/            # Project configuration
â”‚   â”œâ”€â”€ domains/            # Override/extend domains
â”‚   â”œâ”€â”€ workflows/          # Custom workflows
â”‚   â”œâ”€â”€ todos/              # Project todos
â”‚   â”œâ”€â”€ history/            # Project history
â”‚   â”œâ”€â”€ decisions/          # Architecture decisions
â”‚   â””â”€â”€ file-lists/         # Batch operation tracking
â”‚
â””â”€â”€ [PROVIDER].md           # Provider-specific entry point (e.g., CLAUDE.md)
```

Run `/init` to copy `.ai-assistant/.ai-project/` to `.ai-project/` at your project root.

### Resolution Order

When looking for any file, follow this resolution order:

1. **First:** Check `.ai-project/{path}`
2. **Fallback:** Use `.ai-assistant/{path}`

**Examples:**
- Looking for `domains/typescript.instructions.md`:
  1. Check `.ai-project/domains/typescript.instructions.md`
  2. If not found, use `.ai-assistant/domains/typescript.instructions.md`

- Looking for `workflows/commit.prompt.md`:
  1. Check `.ai-project/workflows/commit.prompt.md`
  2. If not found, use `.ai-assistant/workflows/commit.prompt.md`

### What Goes Where

| Layer | Purpose | Examples |
|-------|---------|----------|
| `.ai-assistant/` | Generic, reusable framework | Protocols, roles, default workflows |
| `.ai-project/` | Project-specific content | Memory, context, custom rules, todos |

### Project-Specific Files

These files should ALWAYS be in `.ai-project/`:
- `.memory.md` - Project architecture and tech stack
- `.context.md` - Common patterns and imports
- `project/` - Project commands and structure
- `todos/` - Technical debt tracking
- `history/` - Knowledge from past work
- `decisions/` - Architecture Decision Records
- `file-lists/` - Batch operation tracking

## Execution Protocol

### Following Instructions

When task instructions reference specific commands, procedures, or documentation:

1. **Read completely** - Review the entire referenced instruction file before starting
2. **Follow exactly** - Execute documented steps precisely as written, in the specified order
3. **Ask when unclear** - Request clarification before proceeding if steps are ambiguous
4. **Document deviations** - Only deviate from instructions when explicitly approved by user
5. **Verify completion** - Confirm all steps completed successfully before marking task done

**Default Behavior:** Execute documented procedures without modification or improvisation.

### Instruction Hierarchy

When instructions conflict, follow this priority order:

1. **User's explicit request** (highest priority)
2. **Global instructions** (this file)
3. **Domain-specific instructions** (e.g., `typescript.instructions.md`)
4. **Workflow-specific instructions** (e.g., `refactor.prompt.md`)
5. **General best practices** (lowest priority)

## Documentation Policy

### File Creation Guidelines

**Create freely to support development:**

- Configuration files (tsconfig, vite.config, etc.)
- `*.stories.ts` files (Storybook stories)
- `*.spec.ts` or `*.test.ts` files (tests)
- Source code files (`.ts`, `.tsx`, `.js`, `.jsx`, `.vue`)
- Entries in `.ai-project/todos/`
- File lists in `.ai-project/file-lists/`

**Require explicit user approval before creating:**

- README.md or README files
- Documentation files outside `.ai-assistant/`
- API documentation (Swagger, OpenAPI, JSDoc files)
- Architecture diagrams or design documents
- CHANGELOG.md or release notes
- Generic "how-to" guides

**Rationale:** Code should be self-documenting. External documentation often becomes stale and misleading.

## Communication Style

### Session Start

When a new session begins, introduce available commands:

```markdown
## Available Commands

| Command | Purpose |
|---------|---------|
| `/implement` | Full workflow: explore â†’ plan â†’ code |
| `/debug` | Find and fix a bug |
| `/refactor` | Systematic multi-file changes |
| `/validate` | Run type check, lint, tests |
| `/commit` | Review and commit changes |
| `/pr` | Create pull request |

How can I help you today?
```

### Response Format

- **Concise** - Keep responses short and to the point
- **No summaries** - Don't summarize work after completion unless asked
- **No explanations** - Let code speak for itself unless user requests explanation
- **Action-focused** - Show what you're doing through tool use, not narration
- **Friendly but professional** - Informal tone, but maintain technical accuracy

### Course Correction

When working on a task, use these techniques to adjust direction:

- **Interrupt** - Stop current operation to preserve context and change direction
- **Request undo** - Ask to backtrack on an approach that isn't working
- **Ask for plan** - Request detailed planning before complex implementations
- **Clear context** - Reset between unrelated tasks to improve focus

**When to course correct:**
- Output is going in wrong direction
- Better approach becomes apparent mid-task
- Context is getting cluttered with irrelevant information
- Need to explore alternative solutions

### Communication Templates

Use bordered sections for structured responses. Based on [clig.dev](https://clig.dev/) best practices.

**Quick Recognition:**
```
INFORMATIONAL (no action):     ACTION REQUIRED (must respond):
  âœ… STATUS  - Results           ğŸ”´ ACTION  - Decision needed
  ğŸ’¡ INFO    - Context           ğŸ“ INPUT   - Info needed
  ğŸ’¬ NEXT    - Follow-up         âš¡ CONFIRM - Yes/no

ATTENTION (read carefully):    PROGRESS (during work):
  âš ï¸ WARNING - Caution           âœ“ Complete   â ‹ Working
  âŒ ERROR   - Fix suggestion    â—‹ Pending
```

**Section order:** TASK â†’ STATUS â†’ WARNING â†’ ERROR â†’ ACTION â†’ NEXT

**Example:**
```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ TASK: Refactor component
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… STATUS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  âœ“ Analysis complete
  âœ“ Found 3 patterns to improve

ğŸ”´ ACTION REQUIRED
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Choose approach:
  (A) Quick fix - minimal changes
  (B) Full refactor - comprehensive

ğŸ‘‰ Your choice: _
```

**Full reference:** [domains/communication.instructions.md](./domains/communication.instructions.md)

### Token Optimization

To preserve context window space:

1. **Search before reading** - Use `grep` to find relevant files before reading
2. **Read selectively** - Only read files you need to modify
3. **Avoid re-reading** - Don't re-read files already in conversation context
4. **Plan before executing** - Think through approach before taking action
5. **Use domain instructions** - Reference domain files instead of duplicating content

## Task Management

### Todo Tracking

**Use task tracking for:**

- Complex tasks with 3+ distinct steps
- Non-trivial tasks requiring careful planning
- User provides multiple tasks (numbered or comma-separated list)
- User explicitly requests todo list

**Skip task tracking for simple cases:**

- Single straightforward task
- Trivial task completable in <3 steps
- Purely conversational/informational requests

**Task Management Rules:**

1. Mark task `in_progress` BEFORE starting work (exactly ONE at a time)
2. Mark task `completed` IMMEDIATELY after finishing
3. Update task status in real-time as work progresses
4. Don't batch completions - mark each task complete as it finishes
5. Remove irrelevant tasks from the list entirely

**Task Descriptions:**

- **content:** Imperative form ("Run tests", "Build project")
- **activeForm:** Present continuous form ("Running tests", "Building project")

### Long-Term Todo Tracking

**IMPORTANT:** Track all shortcuts, compromises, and deferred improvements.

When taking shortcuts or identifying future work:

1. Add entry to `.ai-project/todos/` following the template
2. Include affected files/components
3. Explain context and proper solution
4. See [workflows/create-todo.prompt.md](./workflows/create-todo.prompt.md)

### File List Tracking

**IMPORTANT:** Document file batches for large-scale work.

When finding multiple files needing similar changes (>5 files):

1. Create file list in `.ai-project/file-lists/[descriptive-name].md`
2. Document search criteria and commands used
3. Track progress with checkboxes
4. See [workflows/create-file-list.prompt.md](./workflows/create-file-list.prompt.md)

### History Entries

**IMPORTANT:** Preserve knowledge from significant work.

Create a history entry in `.ai-project/history/` after completing:

- Refactors affecting 5+ files
- Architectural changes or pattern migrations
- Bug fixes with non-obvious solutions
- Feature implementations with design decisions

**Entry contents:**
1. Summary of what was accomplished
2. Context and motivation
3. Key decisions and reasoning
4. Before/after patterns
5. Lessons learned

**Naming:** `{type}-{descriptive-name}.md` (e.g., `refactor-api-client.md`)

See `.ai-project/history/README.md` for template and guidelines.

## Scope Management

### Large-Scale Change Policy

**CRITICAL:** Avoid large-scale changes from direct user requests. Redirect to the refactor workflow.

**Scope Thresholds:**

| Scope | Files | Action |
|-------|-------|--------|
| Small | 1-5 files | Proceed directly |
| Medium | 6-20 files | Confirm with user, consider refactor workflow |
| Large | 21+ files | **MUST use [refactor workflow](./workflows/refactor.prompt.md)** |

**When to Invoke Refactor Workflow:**

- User requests rename/replace across multiple files
- Pattern changes affecting many components
- API migrations or library upgrades
- Bulk code modifications
- Any request that would touch 6+ files

**How to Redirect:**

```markdown
> **WARNING:**
> This request would affect [N] files, which qualifies as a [medium/large]-scale change.

> **ACTION REQUIRED:**
> For changes of this scope, I recommend using the refactor workflow (`/refactor`) which provides:
> - Proper planning and scope analysis
> - Pattern detection for edge cases
> - Parallel execution with progress tracking
> - Validation checkpoints
>
> **Proceed with refactor workflow?** (yes/no)
```

**Why This Matters:**

- Large-scale changes without planning lead to inconsistencies
- Edge cases get missed without pattern analysis
- Progress is hard to track across many files
- Validation becomes difficult without checkpoints

## Code Quality Standards

### General Principles

1. **Prefer editing to creating** - Always edit existing files over creating new ones
2. **Follow existing patterns** - Match the style and structure of surrounding code
3. **No premature optimization** - Write clear code first, optimize only when needed
4. **Test as you go** - Run tests for changed components only (never full test suite)
5. **Security awareness** - Avoid XSS, SQL injection, command injection, and OWASP Top 10 vulnerabilities
6. **Scope awareness** - Recognize when requests require large-scale changes and redirect appropriately

### Code Style

- Follow project linter/formatter configuration
- Let tooling handle formatting (don't format manually)

### Comments Policy

**General Rule:** Write comments that explain complex behaviors, not obvious code.

**Write comments for:**
- Non-obvious behavior explanations
- Complex algorithm explanations
- Workaround justifications with ticket references
  - Example: `// WORKAROUND: See TICKET-123 for context`

**Avoid comments for:**
- Comments that repeat function/variable/method names
  - Poor: `// Gets user name` above `getUserName()`

### Logging

- Use project's logger for debug messages
- Never use `console.log` in production code
- Log levels: `debug`, `info`, `warn`, `error`
- Don't log user-facing text (use for debugging only)

## Testing Requirements

### Test Execution Policy

**CRITICAL:** Always scope tests to changed components only.

**Run focused tests:**
```bash
# Examples - adapt to your project's test commands
npm run test -- ComponentName
npm run test:unit -- pattern
npx vitest run file.spec
```

**Avoid full test suite commands unless explicitly requested.**

### Test Plan Requirements

**CRITICAL:** All test files MUST include a test plan as a comment at the top.

**Required for:**
- All `*.spec.ts` unit test files
- All `*.stories.ts` Storybook story files
- All `*.test.ts` integration test files

**Format:** Gherkin syntax (Given-When-Then)

```typescript
/**
 * Test Plan: ComponentName
 *
 * Scenario: Brief description
 *   Given [initial state/context]
 *   When [action or trigger]
 *   Then [expected outcome]
 *   And [additional expectations]
 */
```

See [domains/testing.instructions.md](./domains/testing.instructions.md) for examples.

## Domain-Specific Guidelines

For detailed rules about specific technologies and patterns, see:

- **[TypeScript Rules](./domains/typescript.instructions.md)** - Type usage, imports, exports
- **[Testing Practices](./domains/testing.instructions.md)** - Test patterns, mocking
- **[Communication Templates](./domains/communication.instructions.md)** - User interaction patterns

Add more domain files as your project needs them:
- Vue/React/Angular component patterns
- CSS/styling guidelines
- i18n/translation requirements
- Accessibility standards

## Workflow Guidelines

For step-by-step task instructions, see:

- **[Validate](./workflows/validate.prompt.md)** - Run validation checks
- **[Refactor](./workflows/refactor.prompt.md)** - Systematic codebase refactoring
- **[Create Todo](./workflows/create-todo.prompt.md)** - Document deferred improvements
- **[Create File List](./workflows/create-file-list.prompt.md)** - Track batches of files needing work

## Context Preservation

### Session Memory

**Project Context:** Preserved in [.ai-project/.memory.md](../.ai-project/.memory.md)
- Architecture and tech stack
- Key patterns and conventions
- Known issues and limitations
- Recent work areas

**Quick Reference:** Available in [.ai-project/.context.md](../.ai-project/.context.md)
- Common import patterns
- Frequently used commands
- File locations
- Quick lookup tables

### Updating Context

As you work on the project, update `.ai-project/.memory.md` when:
- Major architectural changes occur
- New patterns are established
- Important decisions are made
- Project structure changes

## Chatmodes

Workflows invoke chatmodes to apply role-specific behavior and constraints:

| Chatmode | Purpose | Capabilities |
|----------|---------|--------------|
| ğŸ” [Explorer](./chatmodes/explorer.chatmode.md) | Understand code | Read-only exploration, pattern discovery |
| ğŸ“‹ [Planner](./chatmodes/planner.chatmode.md) | Design approach | Create plans, identify risks, read-only |
| ğŸ‘¨â€ğŸ’» [Developer](./chatmodes/developer.chatmode.md) | Code implementation | Edit files, run commands, create tests |
| ğŸ§ª [Tester](./chatmodes/tester.chatmode.md) | Quality assurance | Create tests, verify behavior |
| ğŸ‘ï¸ [Reviewer](./chatmodes/reviewer.chatmode.md) | Code review | Read-only, suggest improvements |
| ğŸ—ï¸ [Architect](./chatmodes/architect.chatmode.md) | Design and planning | Read-only, create ADRs |
| ğŸ› [Debugger](./chatmodes/debugger.chatmode.md) | Diagnose problems | Read + limited bash for investigation |
| ğŸ’¾ [Committer](./chatmodes/committer.chatmode.md) | Stage and commit | Git operations with user confirmation |
| â™»ï¸ [Refactorer](./chatmodes/refactorer.chatmode.md) | Multi-file changes | Full access with file list tracking |
| ğŸš€ [Releaser](./chatmodes/releaser.chatmode.md) | Create PRs | Git/gh commands, branch management |

**Usage:** Workflows specify which chatmode(s) they use. The chatmode defines what actions are permitted during that phase of work.

---

**Last Updated:** 2025-11-29
**Version:** 1.0
